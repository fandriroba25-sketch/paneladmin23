<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Users & Devices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { display: flex; min-height: 100vh; overflow-x: hidden; }
    .sidebar { width: 250px; background: #0d6efd; color: white; padding: 20px; }
    .sidebar a { color: white; display: block; padding: 10px; border-radius: 6px; text-decoration: none; }
    .sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.2); }
    .content { flex: 1; padding: 30px; background: #f8f9fa; }
    .device-list { margin-left: 20px; font-size: 0.9em; color: #333; }
    .device-item { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body onload="initPage()">

  <div class="sidebar">
    <h4>⚙️ Admin Panel</h4>
    <hr>
    <a href="dashboard.html">📊 Dashboard</a>
    <a href="admin.html" class="active">👥 Manage Users</a>
    <a href="setting.html">⚙️ Settings</a>
    <a href="#" onclick="logout()">🚪 Logout</a>
  </div>

  <div class="content">
    <h3>Manage Users & Devices</h3>
    <hr>

    <!-- Add User Form -->
    <form class="card p-3 shadow-sm mb-4">
      <div class="mb-3">
        <label>Username</label>
        <input type="text" id="username" class="form-control" placeholder="Enter username">
      </div>
      <div class="mb-3">
        <label>Device Access Limit</label><br>
        <input type="radio" name="limit" value="1" checked> 1 Device
        <input type="radio" name="limit" value="100" class="ms-3"> 100 Devices
        <input type="radio" name="limit" value="unlimited" class="ms-3"> Unlimited Devices
      </div>
      <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
    </form>

    <h5>User List</h5>
    <ul id="userList" class="list-group mt-3"></ul>
  </div>

  <script>
    // ---------------------------
    // LOGIN CHECK
    // ---------------------------
    function initPage() {
      if (localStorage.getItem("loggedIn") !== "true") {
        window.location.href = "index.html";
      }
      loadUsers();
    }

    function logout() {
      localStorage.removeItem("loggedIn");
      window.location.href = "index.html";
    }

    // ---------------------------
    // USER STORAGE MANAGEMENT
    // ---------------------------
    function getUsers() {
      return JSON.parse(localStorage.getItem("users") || "[]");
    }

    function saveUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }

    // ---------------------------
    // USER MANAGEMENT
    // ---------------------------
    function addUser() {
      const username = document.getElementById("username").value.trim();
      const limit = document.querySelector('input[name="limit"]:checked')?.value;

      if (!username) return alert("Please enter a username");

      let users = getUsers();
      if (users.find(u => u.name === username)) {
        alert("User already exists!");
        return;
      }

      users.push({
        name: username,
        devices: [],
        limit: limit
      });

      saveUsers(users);
      document.getElementById("username").value = "";
      loadUsers();
    }

    function deleteUser(username) {
      if (!confirm(`Delete user ${username}?`)) return;
      let users = getUsers().filter(u => u.name !== username);
      saveUsers(users);
      loadUsers();
    }

    // ---------------------------
    // DEVICE MANAGEMENT
    // ---------------------------
    function addDevice(username) {
      let users = getUsers();
      const user = users.find(u => u.name === username);
      if (!user) return;

      // Check device limit
      if (user.limit !== "unlimited" && user.devices.length >= parseInt(user.limit)) {
        alert(`${username} has reached the device limit (${user.limit}).`);
        return;
      }

      const deviceName = prompt(`Enter device name for ${username}:`);
      if (!deviceName) return;

      user.devices.push(deviceName);
      saveUsers(users);
      loadUsers();
    }

    function deleteDevice(username, deviceIndex) {
      let users = getUsers();
      const user = users.find(u => u.name === username);
      if (user) {
        user.devices.splice(deviceIndex, 1);
        saveUsers(users);
        loadUsers();
      }
    }

    // ---------------------------
    // RENDER USER LIST
    // ---------------------------
    function loadUsers() {
      const list = document.getElementById("userList");
      list.innerHTML = "";

      let users = getUsers();
      if (users.length === 0) {
        list.innerHTML = "<li class='list-group-item'>No users yet.</li>";
        return;
      }

      users.forEach(u => {
        const li = document.createElement("li");
        li.className = "list-group-item";

        const limitText = u.limit === "unlimited" ? "Unlimited" : `${u.limit}`;

        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${u.name}</strong><br>
              <span class="device-list">Devices: ${u.devices.length} / ${limitText}</span>
            </div>
            <div>
              <button class="btn btn-sm btn-success me-2" onclick="addDevice('${u.name}')">+ Add Device</button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.name}')">🗑 Delete User</button>
            </div>
          </div>
          <ul class="device-list mt-2">
            ${
              u.devices.length === 0
              ? "<li>No devices yet.</li>"
              : u.devices.map((d, i) => `
                <li class="device-item">
                  ${d}
                  <button class="btn btn-sm btn-outline-danger btn-sm py-0" onclick="deleteDevice('${u.name}', ${i})">❌</button>
                </li>
              `).join("")
            }
          </ul>
        `;

        list.appendChild(li);
      });
    }
  </script>
</body>
</html>
